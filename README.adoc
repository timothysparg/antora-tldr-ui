= Antora TLDR UI
// Variables:
:current-release: prod-1
// Settings:
:experimental:
:hide-uri-scheme:
:toc: macro
ifdef::env-github[]
:important-caption: :exclamation:
:tip-caption: :bulb:
:!toc-title:
:badges:
endif::[]
// Project URLs:
:project-repo-name: timothysparg/antora-tldr-ui
:url-project: https://github.com/{project-repo-name}
:url-preview: https://antora-tldr-ui.netlify.app
:url-ci: {project-repo-name}/actions
:url-netlify-deploys: https://app.netlify.com/sites/antora-tldr-ui/deploys
// External URLs:
:url-antora: https://antora.org
:url-antora-docs: https://docs.antora.org
:url-antora-default-ui: https://gitlab.com/antora/antora-ui-default
:url-asciidoctor: https://asciidoctor.org
:url-git: https://git-scm.com
:url-git-dl: {url-git}/downloads
:url-opendevise: https://opendevise.com
:url-nodejs: https://nodejs.org
:url-mise: https://mise.jdx.dev
:url-mise-install: {url-mise}/getting-started.html
:url-source-maps: https://developer.mozilla.org/en-US/docs/Tools/Debugger/How_to/Use_a_source_map

ifdef::badges[]
image:https://img.shields.io/github/release/{project-repo-name}.svg[Latest Release,link={url-project}/releases/latest/download/ui-bundle.zip]
image:https://api.netlify.com/api/v1/badges/a9db5e1b-d7b7-48c0-b066-1b8d91e9c3d1/deploy-status[Deploy Status,link={url-netlify-deploys}]
endif::[]

toc::[]

This project provides a blog-focused UI theme for Antora sites.
It provides both the visual theme and user interactions optimized for blog-style content.
The UI bundle that this project produces is designed to be used with Antora.
It bundles the HTML templates (layouts, partials, and helpers), CSS, JavaScript, fonts, and site-wide images.
The rest of the material for the docs site comes from the content repositories.

== Usage

To use this UI with Antora, add the following configuration to the playbook file for your site:

[,yaml,subs=attributes+]
----
ui:
  bundle:
    url: {url-project}/releases/download/{current-release}/ui-bundle.zip
----

To avoid having to manage the release number in the URL, you can grab the latest release using the following configuration instead:

[,yaml,subs=attributes+]
----
ui:
  bundle:
    url: {url-project}/releases/latest/download/ui-bundle.zip
----

In order for Antora to fetch the latest UI bundle in this case, the `--fetch` option must be used and the `snapshot` key must be set to `true` to bypass the cache.

Read on to learn how to develop the UI.

== Development Quickstart

This section offers a basic tutorial to teach you how to set up the UI project, preview it locally, and bundle it for use with Antora.
A more comprehensive tutorial can be found in the documentation at {url-antora-docs}.

=== Prerequisites

To preview and bundle the UI, you need the following software on your computer:

* {url-git}[git] (command: `git`)
* {url-nodejs}[Node.js] (commands: `node`, `npm`, and `npx`)

==== git

First, make sure you have git installed.

 $ git --version

If not, {url-git-dl}[download and install] the git package for your system.

==== Node.js

Next, make sure that you have Node.js installed (which also provides npm).

 $ node --version

If this command fails with an error, you don't have Node.js installed.
If the command doesn't report an active LTS version of Node.js (e.g., v16.16.0), it means you don't have a suitable version of Node.js installed.
In this guide, we'll be installing Node.js 16.

While you can install Node.js from the official packages, we strongly recommend that you use {url-mise}[Mise] (polyglot runtime manager) to manage your Node.js installation(s).
Follow the {url-mise-install}[Mise installation instructions] to set up Mise on your machine.

Once you've installed Mise, open a new terminal and install Node.js using the following command (the project's .mise.toml file specifies the required version):

 $ mise install

Mise will automatically use the correct Node.js version when you're in the project directory.
The Node.js version is managed via the .mise.toml file in the project root.

Now that you have Node.js installed, you can proceed with cloning and initializing the project.

=== Clone and Initialize the UI Projectc

Clone the UI project using git:

[subs=attributes+]
 $ git clone {url-project} &&
   cd "`basename $_`"

The example above clones the UI project and then switches to the project folder on your filesystem.
Stay in this project folder when executing all subsequent commands.

Use npm to install the project's dependencies inside the project.
In your terminal, execute the following command:

 $ npm ci

This command installs the dependencies listed in [.path]_package.json_ into the [.path]_node_modules/_ folder inside the project.
This folder does not get included in the UI bundle and should _not_ be committed to the source control repository.

=== Preview the UI

The UI project is configured to preview offline.
The files in the [.path]_preview-src/_ folder provide the sample content that allow you to see the UI in action.
In this folder, you'll primarily find pages written in AsciiDoc.
These pages provide a representative sample and kitchen sink of content from the real site.

To build the UI and preview it in a local web server, run the development server:

 $ npm start

This command builds the preview pages and starts Vite's development server with Hot Module Replacement (HMR) for fast development.

[TIP]
====
You can also use the `dev` command directly:

 $ npm run dev

The development server uses Vite for fast builds and automatic browser refresh when files change.
====

You'll see a URL listed in the output of this command:

....
[12:00:00] Starting server...
[12:00:00] Server started http://localhost:5252
[12:00:00] Running server
....

Navigate to this URL to preview the site locally.

While this command is running, any changes you make to the source files will be instantly reflected in the browser.
This works by monitoring the project for changes, running the `preview:build` task if a change is detected, and sending the updates to the browser.

Press kbd:[Ctrl+C] to stop the preview server and end the continuous build.

=== Package for Use with Antora

If you need to package the UI so you can use it to generate the documentation site locally, run the following command:

 $ npm run build

This command runs linting, cleans previous builds, and creates the production bundle using Vite.
If any errors are reported by lint, you'll need to fix them.

When the command completes successfully, the UI bundle will be available at [.path]_build/ui-bundle.zip_.
You can point Antora at this bundle using the `--ui-bundle-url` command-line option.

Alternatively, you can use the `bundle` command:

 $ npm run bundle

Both commands produce the same ui-bundle.zip file.

==== Source Maps

The build consolidates all the CSS and client-side JavaScript into combined files, [.path]_site.css_ and [.path]_site.js_, respectively, in order to reduce the size of the bundle.
{url-source-maps}[Source maps] correlate these combined files with their original sources.

This "`source mapping`" is accomplished by generating additional map files that make this association.
These map files sit adjacent to the combined files in the build folder.
The mapping they provide allows the debugger to present the original source rather than the obfuscated file, an essential tool for debugging.

In development mode, source maps are enabled automatically by Vite for fast debugging.
For production builds, Vite optimizes the bundle without source maps by default.

If you need to include source maps in the production bundle for debugging, you can modify the Vite configuration in [.path]_vite.config.js_ to enable source maps in production builds.

=== Create an Online Preview

You can share a preview of the UI online by submitting a pull request to GitHub.
The repository is configured to create a deploy preview on Netlify for every pull request.
Here's how that process works:

. Fork the repository on GitHub (only has to be done once).
. Create a local branch.
. Make changes to the UI.
. Commit your changes to that branch.
. Push that branch to your fork (on GitHub).
. Submit a pull request from the branch you pushed to your fork.
. Wait for deploy/netlify check to say "`Deploy preview ready!`" on the pull request page.
. Click on the "`Details`" link under "`Show all checks`" on the pull request page to get the preview URL.
. Visit the preview URL to view your changes or share the preview URL with others.

The deploy preview works because there is a webhook on the repository that pings \https://api.netlify.com/hooks/github for the following events: push, pull_request, delete_branch.
Netlify then runs the command specified in netlify.toml, deploys the site, and allocates a temporary preview URL for it.

Included in that temporary preview URL is the UI bundle itself.
That means you can test it directly with Antora.
To access the UI bundle, append `dist/ui-bundle.zip` to the end of the preview URL, then pass that URL to Antora as follows:

 $ antora --ui-bundle-url=<preview URL>/dist/ui-bundle.zip antora-playbook.yml

The temporary preview URL will automatically be decommissioned once the PR is closed.

== Releases

Releases are automated using Release Please and GitHub Actions.
The process works as follows:

. Release Please opens a release pull request that bumps the version in `package.json` and updates `CHANGELOG.md` based on conventional commits.
. When you merge the release PR, Release Please creates a semver tag (e.g., `v0.1.0`) and a GitHub Release with generated notes.
. A separate workflow (triggered on release published) builds the UI, produces `build/ui-bundle.zip`, writes the tag into `ui.yml` during the build, and uploads the asset to the GitHub Release.

Notes:

- Linting runs as part of the build step; releases should pass lint.
- Consumers can download the latest UI bundle from `{url-project}/releases/latest/download/ui-bundle.zip`.
- The `:current-release:` attribute in this README is updated automatically by Release Please and can be used if an explicit version is preferred.

=== CI Jobs

- Release automation is defined in [.path]_.github/workflows/release-please.yml_.
- Asset build and upload on release is defined in [.path]_.github/workflows/release-build.yml_.

Once a release is published, you can reference the bundle URL in your Antora playbook.
See <<Usage>> for details.

== Copyright and License

=== Software

This project is a derivative of the {url-antora-default-ui}[Antora default UI].
The software assets in this repository (web JavaScript files, Handlebars templates and JavaScript helpers, common CSS, utility icons, etc.) come from the {url-antora}[Antora project].
As such, use of the software is granted under the terms of the https://www.mozilla.org/en-US/MPL/2.0/[Mozilla Public License Version 2.0] (MPL-2.0).
See link:LICENSE[] to find the full license text.

=== Branding and Design

Copyright (C) {url-asciidoctor}[Asciidoctor] 2018-present.
This includes any CSS that provides colors or iconography that depict the Asciidoctor brand.
All rights reserved (until further notice).
