= Antora TLDR UI
// Variables:
// Settings:
:experimental:
:hide-uri-scheme:
:toc: macro
ifdef::env-github[]
:important-caption: :exclamation:
:tip-caption: :bulb:
:!toc-title:
:badges:
endif::[]
// Project URLs:
:project-repo-name: timothysparg/antora-tldr-ui
:url-project: https://github.com/{project-repo-name}
:url-preview: https://antora-tldr-ui.netlify.app
:url-ci: {project-repo-name}/actions
:url-netlify-deploys: https://app.netlify.com/sites/antora-tldr-ui/deploys
// External URLs:
:url-antora: https://antora.org
:url-antora-docs: https://docs.antora.org
:url-antora-default-ui: https://gitlab.com/antora/antora-ui-default
:url-asciidoctor: https://asciidoctor.org
:url-git: https://git-scm.com
:url-git-dl: {url-git}/downloads
:url-opendevise: https://opendevise.com
:url-nodejs: https://nodejs.org
:url-mise: https://mise.jdx.dev
:url-mise-install: {url-mise}/getting-started.html
:url-source-maps: https://developer.mozilla.org/en-US/docs/Tools/Debugger/How_to/Use_a_source_map

ifdef::badges[]
image:https://img.shields.io/github/release/{project-repo-name}.svg[Latest Release,link={url-project}/releases/latest/download/ui-bundle.zip]
image:https://api.netlify.com/api/v1/badges/a9db5e1b-d7b7-48c0-b066-1b8d91e9c3d1/deploy-status[Deploy Status,link={url-netlify-deploys}]
endif::[]

toc::[]

This project provides a blog-focused UI theme for Antora sites.
It provides both the visual theme and user interactions optimized for blog-style content.
The UI bundle that this project produces is designed to be used with Antora.
It bundles the HTML templates (layouts, partials, and helpers), CSS, JavaScript, fonts, and site-wide images.
The rest of the material for the docs site comes from the content repositories.

== Usage

To use this UI with Antora, reference the latest release bundle:

[,yaml,subs=attributes+]
----
ui:
  bundle:
    url: {url-project}/releases/latest/download/ui-bundle.zip
----

In order for Antora to fetch the latest UI bundle in this case, the `--fetch` option must be used and the `snapshot` key must be set to `true` to bypass the cache.

Read on to learn how to develop the UI.

== Development Quickstart

This section offers a basic tutorial to teach you how to set up the UI project, preview it locally, and bundle it for use with Antora.
A more comprehensive tutorial can be found in the documentation at {url-antora-docs}.

=== Prerequisites

To preview and bundle the UI, you need the following software on your computer:

* {url-git}[git] (command: `git`)
* {url-nodejs}[Node.js] (commands: `node`, `npm`, and `npx`)

==== git

First, make sure you have git installed.

 $ git --version

If not, {url-git-dl}[download and install] the git package for your system.

==== Node.js

Next, make sure that you have Node.js installed (which also provides npm).

 $ node --version

If this command fails with an error, you don't have Node.js installed.
If the command doesn't report an active LTS version of Node.js (e.g., v16.16.0), it means you don't have a suitable version of Node.js installed.
In this guide, we'll be installing Node.js 16.

While you can install Node.js from the official packages, we strongly recommend that you use {url-mise}[Mise] (polyglot runtime manager) to manage your Node.js installation(s).
Follow the {url-mise-install}[Mise installation instructions] to set up Mise on your machine.

Once you've installed Mise, you'll use the following command _after cloning this repository_ (run from the project root; the [.path]_.mise.toml_ file specifies the required versions):

 $ mise install

Mise will automatically use the correct Node.js version when you're in the project directory and will install the `hk` CLI defined in [.path]_.mise.toml_.
The Node.js version (and other tools) are managed via the .mise.toml file in the project root.

Now that you have Node.js installed, you can proceed with cloning and initializing the project.

=== Clone and Initialize the UI Project

Clone the UI project using git:

[subs=attributes+]
 $ git clone {url-project} &&
   cd "`basename $_`"

The example above clones the UI project and then switches to the project folder on your filesystem.
Stay in this project folder when executing all subsequent commands.

With the repository cloned, install the toolchain declared in [.path]_.mise.toml_ (Node.js, hk, and other CLI dependencies) and register hk's git hooks:

 $ mise install
 $ hk setup

Use npm to install the project's dependencies inside the project.
In your terminal, execute the following command:

 $ npm ci

This command installs the dependencies listed in [.path]_package.json_ into the [.path]_node_modules/_ folder inside the project.
This folder does not get included in the UI bundle and should _not_ be committed to the source control repository.


=== Linting

The lint workflow is defined in [.path]_hk.pkl_ and executed with the `hk` CLI that Mise installs for you.
Run linting with:

 $ hk run check --all

To automatically fix what can be corrected, run:

 $ hk run fix --all

The linting workflow includes:

* **JavaScript/TypeScript**: Biome for code quality and formatting
* **CSS**: stylelint for style validation and best practices
* **HTML Templates**: djLint for Handlebars template validation and accessibility checks
* **GitHub Actions**: actionlint for workflow validation

=== Preview the UI

The UI project is configured to preview offline.
The files in the [.path]_preview-src/_ folder provide the sample content that allow you to see the UI in action.
In this folder, you'll primarily find pages written in AsciiDoc.
These pages provide a representative sample and kitchen sink of content from the real site.

To build the UI and preview it in a local web server, run the development server:

 $ mise run dev

This command runs the Antora preview build once to populate [.path]_public/_ and then launches live-server plus watchexec watchers for preview content and UI theme files. Mise orchestrates the dependent processes so you get fast feedback without juggling multiple terminals.

You'll see a URL listed in the output of this command:

....
[12:00:00] Starting server...
[12:00:00] Server started http://localhost:5252
[12:00:00] Running server
....

Navigate to this URL to preview the site locally.

While this command is running, any changes you make to `preview-src/modules/ROOT` or the files under [.path]_src/_ will trigger mise's watch tasks to rerun the preview build; live-server automatically reloads the browser when the Antora output changes.

Press kbd:[Ctrl+C] to stop the preview server and end the continuous build.

=== Package for Use with Antora

If you need to package the UI so you can use it to generate the documentation site locally, run the following command:

 $ mise run bundle

This command executes the CSS/JS build steps, copies static assets, and bundles everything into a distributable archive.
If any errors are reported during the build, you'll need to fix them before the bundle is produced.

When the command completes successfully, the UI bundle will be available at [.path]_build/ui-bundle.zip_.
You can point Antora at this bundle using the `--ui-bundle-url` command-line option.

==== Source Maps

The build consolidates all the CSS and client-side JavaScript into combined files, [.path]_site.css_ and [.path]_site.js_, respectively, in order to reduce the size of the bundle.
{url-source-maps}[Source maps] correlate these combined files with their original sources.

This "`source mapping`" is accomplished by generating additional map files that make this association.
These map files sit adjacent to the combined files in the build folder.
The mapping they provide allows the debugger to present the original source rather than the obfuscated file, an essential tool for debugging.

JavaScript bundles are produced by esbuild with external source maps so you can debug locally; the zip step omits `*.map` files by default. CSS maps are disabled in the PostCSS task. If you need source maps inside the published bundle, adjust the `zip` exclusions in `.mise.toml` and remove `--no-map` from `build:css`.

=== Create an Online Preview

You can share a preview of the UI online by submitting a pull request to GitHub.
The repository is configured to create a deploy preview on Netlify for every pull request.
Here's how that process works:

. Fork the repository on GitHub (only has to be done once).
. Create a local branch.
. Make changes to the UI.
. Commit your changes to that branch.
. Push that branch to your fork (on GitHub).
. Submit a pull request from the branch you pushed to your fork.
. Wait for deploy/netlify check to say "`Deploy preview ready!`" on the pull request page.
. Click on the "`Details`" link under "`Show all checks`" on the pull request page to get the preview URL.
. Visit the preview URL to view your changes or share the preview URL with others.

The deploy preview works because there is a webhook on the repository that pings \https://api.netlify.com/hooks/github for the following events: push, pull_request, delete_branch.
Netlify then runs the command specified in netlify.toml, deploys the site, and allocates a temporary preview URL for it.

Included in that temporary preview URL is the UI bundle itself.
That means you can test it directly with Antora.
To access the UI bundle, append `dist/ui-bundle.zip` to the end of the preview URL, then pass that URL to Antora as follows:

 $ antora --ui-bundle-url=<preview URL>/dist/ui-bundle.zip antora-playbook.yml

The temporary preview URL will automatically be decommissioned once the PR is closed.

== Releases

Releases are automated using Release Please and GitHub Actions.
The process works as follows:

. Release Please opens a release pull request that bumps the version in `version.txt` and updates `CHANGELOG.md` based on conventional commits.
. When you merge the release PR, Release Please creates a semver tag (e.g., `v0.1.0`) and a GitHub Release with generated notes.
. A separate workflow (triggered on release published) builds the UI, produces `build/ui-bundle.zip`, writes the tag into `ui.yml` during the build, and uploads the asset to the GitHub Release.

Notes:

- Linting runs as part of the build step; releases should pass lint.
- Consumers can download the latest UI bundle from `{url-project}/releases/latest/download/ui-bundle.zip`.

=== CI Jobs

- Release automation is defined in [.path]_.github/workflows/release-please.yml_.
- Asset build and upload on release is defined in [.path]_.github/workflows/release-build.yml_.

Once a release is published, you can reference the bundle URL in your Antora playbook.
See <<Usage>> for details.

== Copyright and License

=== Software

This project is a derivative of the {url-antora-default-ui}[Antora default UI].
The software assets in this repository (web JavaScript files, Handlebars templates and JavaScript helpers, common CSS, utility icons, etc.) come from the {url-antora}[Antora project].
As such, use of the software is granted under the terms of the https://www.mozilla.org/en-US/MPL/2.0/[Mozilla Public License Version 2.0] (MPL-2.0).
See link:LICENSE[] to find the full license text.

=== Branding and Design

Copyright (C) {url-asciidoctor}[Asciidoctor] 2018-present.
This includes any CSS that provides colors or iconography that depict the Asciidoctor brand.
All rights reserved (until further notice).
