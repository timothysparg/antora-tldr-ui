#:schema https://mise.jdx.dev/schema/mise-task.json

[default]
description = "Start development server (alias for dev)"
alias = "dev"

[preview]
description = "Build preview using Antora"
run = """
  mise run bundle
  cd preview-src
  npx antora antora-playbook.yml \
    --log-level=${ANTORA_LOG_LEVEL:-info} \
    --cache-dir=${ANTORA_CACHE_DIR}
"""
sources = ["preview-src/**/*.{yml,adoc}"]
outputs = ["public/**"]

["preview:content-only"]
description = "Rebuild Antora site with existing UI bundle"
run = """
  cd preview-src
  npx antora antora-playbook.yml \
    --log-level=${ANTORA_LOG_LEVEL:-info} \
    --cache-dir=${ANTORA_CACHE_DIR}
"""

["preview:theme-only"]
description = "Rebuild UI bundle and Antora site"
run = """
  mise run bundle
  cd preview-src
  npx antora antora-playbook.yml \
    --log-level=${ANTORA_LOG_LEVEL:-info} \
    --cache-dir=${ANTORA_CACHE_DIR}
"""

[serve]
description = "Serve preview with live reload"
run = """
  npx live-server \
    --host=127.0.0.1 \
    --port=5252 \
    --watch=public \
    --mount=/vendor:node_modules \
    --no-browser \
    public
"""

["watch:preview"]
description = "Watch preview content and rebuild"
run = "mise watch preview:content-only --clear"

["watch:theme"]
description = "Watch theme files and rebuild"
run = """
  watchexec \
    --watch src/layouts \
    --watch src/partials \
    --watch src/helpers \
    --watch src/css \
    --watch src/js \
    --watch src/img \
    --clear \
    -- \
    mise run preview:theme-only
"""

[dev]
description = "Start development server"
depends = ["preview"]
run = [{ task = "serve" }, { task = "watch:preview" }, { task = "watch:theme" }]

[bundle]
description = "Create UI bundle for distribution"
run = """
  TAG=${TAG:-v$(node -p "require('./package.json').version")}
  export TAG
  npm run bundle
"""
outputs = ["ui-bundle.zip"]

[clean]
description = "Clean generated files"
run = """
  rm -rf public build .antora-cache ui-bundle.zip
"""

[validate]
description = "Validate Antora setup"
run = """
  test -f preview-src/antora.yml || echo "ERROR: Missing antora.yml"
  test -f preview-src/antora-playbook.yml || echo "ERROR: Missing playbook"
  test -d preview-src/modules/ROOT/pages || echo "ERROR: Missing pages directory"
  echo "Checking UI structure..."
  test -d src/layouts || echo "ERROR: Missing layouts"
  test -d src/partials || echo "ERROR: Missing partials"
  echo "Validation complete!"
"""
