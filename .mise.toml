[tools]
# Use latest LTS version of Node.js
node = "lts"
hk = "latest"
pkl = "latest"
biome = "latest"
actionlint = "latest"
"pipx:djlint" = "latest"
shellcheck = "latest"
watchexec = "latest"

[env]
ANTORA_LOG_LEVEL = "info"
ANTORA_CACHE_DIR = ".antora-cache"

[tasks.preview]
description = "Build preview using Antora"
run = """
  mise run bundle
  cd preview-src
  npx antora antora-playbook.yml \
    --log-level=${ANTORA_LOG_LEVEL:-info} \
    --cache-dir=${ANTORA_CACHE_DIR:-.antora-cache}
"""
sources = ["preview-src/**/*.{yml,adoc}"]
outputs = ["public/**"]

[tasks.serve]
description = "Serve preview with live reload"
run = """
  npx live-server \
    --host=127.0.0.1 \
    --port=5252 \
    --watch=public \
    --mount=/vendor:node_modules \
    --no-browser \
    public
"""

[tasks."watch:preview"]
description = "Watch preview content and rebuild"
run = "mise watch preview --clear"

[tasks."watch:theme"]
description = "Watch theme files and rebuild"
run = """
  watchexec \
    --watch src/layouts \
    --watch src/partials \
    --watch src/helpers \
    --watch src/css \
    --watch src/js \
    --watch src/img \
    --clear \
    -- \
    mise run preview
"""

[tasks.dev]
description = "Start development server"
depends = ["preview"]
run = [
  { task = "serve" },
  { task = "watch:preview" },
  { task = "watch:theme" }
]

[tasks.bundle]
description = "Create UI bundle for distribution"
run = """
  TAG=${TAG:-v$(node -p "require('./package.json').version")}
  export TAG
  npm run bundle
"""
outputs = ["ui-bundle.zip"]

[tasks.clean]
description = "Clean generated files"
run = """
  rm -rf public build .antora-cache ui-bundle.zip
"""

[tasks.validate]
description = "Validate Antora setup"
run = """
  echo "Checking Antora structure..."
  test -f preview-src/antora.yml || echo "ERROR: Missing antora.yml"
  test -f preview-src/antora-playbook.yml || echo "ERROR: Missing playbook"
  test -d preview-src/modules/ROOT/pages || echo "ERROR: Missing pages directory"
  echo "Checking UI structure..."
  test -d src/layouts || echo "ERROR: Missing layouts"
  test -d src/partials || echo "ERROR: Missing partials"
  echo "Validation complete!"
"""
